# Nome do workflow (aparece na aba "Actions" do GitHub)
name: Ruby CI

# Define quando o workflow será executado
on:
  # Executa somente quando um Pull Request for aberto ou atualizado
  pull_request:
    # Apenas se o PR for para a branch main
    branches: ["main"]

# Permissões mínimas por segurança
permissions:
  contents: read

# Lista de jobs do workflow
jobs:
  # ======================
  # JOB 1 — LINT (Rubocop)
  # ======================
  lint:
    # Sistema operacional da máquina virtual
    runs-on: ubuntu-latest

    # Passos executados nesse job
    steps:
      # Baixa o código do repositório para a máquina do GitHub
      - uses: actions/checkout@v4

      # Instala e configura o Ruby
      - uses: ruby/setup-ruby@v1
        with:
          # Versão fixa do Ruby para rodar o RuboCop
          # Normalmente usa-se a versão principal do projeto
          ruby-version: "3.4"

          # Instala o Bundler correto, roda bundle install
          # e faz cache das gems automaticamente
          bundler-cache: true

      # Executa o RuboCop (lint)
      # Se falhar, o job falha e o PR é bloqueado
      - name: Run RuboCop
        run: bundle exec rubocop

  # ======================
  # JOB 2 — TESTES (RSpec)
  # ======================
  test:
    # Sistema operacional da máquina virtual
    runs-on: ubuntu-latest

    # Estratégia de matrix para rodar o job várias vezes
    strategy:
      matrix:
        # O job será executado uma vez para cada versão abaixo
        ruby: ["3.2", "3.3", "3.4"]

    # Passos executados nesse job
    steps:
      # Baixa o código novamente (cada job é isolado)
      - uses: actions/checkout@v4

      # Instala o Ruby de acordo com a versão da matrix
      - uses: ruby/setup-ruby@v1
        with:
          # Usa a versão atual da matrix (3.2, 3.3 ou 3.4)
          ruby-version: ${{ matrix.ruby }}

          # Instala dependências e usa cache do Bundler
          bundler-cache: true

      # Executa os testes automatizados
      # Se qualquer teste falhar em qualquer versão,
      # o job falha e o PR não pode ser mergeado
      - name: Run RSpec
        run: bundle exec rspec
